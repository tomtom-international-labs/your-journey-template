<!DOCTYPE html>
<html class='use-all-space'>
<head>
    <meta http-equiv='X-UA-Compatible' content='IE=Edge' />
    <meta charset='UTF-8'>
    <title>My TomTom Maps APIs Journey</title>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.39.0/maps/maps.css'>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.42.0/maps/css-styles/poi.css'/>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.39.0/maps/maps-web.min.js"></script>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.39.0/services/services-web.min.js"></script>
</head>
    
<style>
    .icon {
        background-size: cover;
        height: 30px;
        width: 30px;
    }
</style>
    
<body>
    <h4>Add your API KEY in the script section</h4>
    <div style='width:100vw; height: 90vh' id='map' class='map'></div>
    <div id='address'>?</div>
    
    <script>
        // Add your api key in the form :  var API_KEY = xxxxxxxx
        // Visit developer.tomtom.com if you don't have one
        var API_KEY = 0123456789
        
        var TORONTO = {lng: -79.379556, lat: 43.648321};
        var currentLocationMarker = null;
        var destinationMarker = null;
        
        var getCoffeeIcon = function() {
            var element = document.createElement('div');
            element.className = 'icon tt-icon-shield';
            var innerElement = document.createElement('div');
            innerElement.className = 'icon tt-icon-ic_map_poi_120-white';
            element.appendChild(innerElement);
            return element;
        }

        // Add the array of markers POIs to the map
        var currentMarkers = [];
        var addPOIs = function(array) {
            if (currentMarkers.length != 0) {
                currentMarkers.forEach( function(marker){
                    marker.remove();
                });
            }
            currentMarkers = [];
            // Create new Markers
            array.forEach(function(poi){
                console.log('adding '+poi);
                var marker = new tt.Marker(getCoffeeIcon());
                marker.setLngLat(poi.position);
                marker.addTo(map);
                currentMarkers.push(marker);
            });
            
        }
        
        // Text is a search keyword for the Fuzzy Search API
        // coordinates is an array of coordinates representing the route.
        var searchFor = function(text, coordinates) {
            tt.services.alongRouteSearch({
                key: API_KEY,
                limit: 20,
                maxDetourTime: 120,
                query: text,
                route: coordinates
            })
            .go()
            .then(function(response) {
                console.log('SUMMARY:');
                console.table(response.summary);
                console.log('RESULTS:');
                console.table(response.results);
                // Now lets add those POIs to the map
                addPOIs(response.results);
            });
        }
        
        var routeLayer = null;
        var displayRoute = function(geoJSON) {
            routeLayer = map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': {
                    'type': 'geojson',
                    'data': geoJSON
                },
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': 'blue',
                    'line-width': 12,
                    'line-dasharray': [2, 2]
                }
            });
        }
        
        // Route Options - Pedestrian route.
        var routeOptions = {
            key: API_KEY,
            departAt: 'now',
            locations : [],
            instructionsType : 'text',
            traffic: false,
            travelMode: 'pedestrian'
        };
        
        // Reverse geocode a location to get the address, return a promise
        var fetchAddress = function (coordinates) {
            return tt.services.reverseGeocode({
                key: API_KEY,
                position: coordinates
            }).go();
        };
        
        var trafficIncidentsConfig = {
            key: API_KEY,
            incidentTiles: {
                style: 'tomtom://vector/1/s3'
            }, 
            incidentDetails: {
                style: 's2'
            }
        }
        
        var map = tt.map({
            key: API_KEY,
            container: 'map',
            basePath: 'sdk/',
            theme: {
                style: 'main',
                layer: 'basic',
                source: 'vector'
            },
            dragPan: true,
            center: TORONTO,
            zoom: 13
        });
        
        map.addControl(new tt.NavigationControl());

        // Display the location on click
        map.on('click', function(event) {
            console.log(event.lngLat);
            fetchAddress(event.lngLat)
                .then(function (reverseGeocodeResponse) {
                    console.log(reverseGeocodeResponse);
                    var address = reverseGeocodeResponse.addresses[0].address.freeformAddress;
                    if (!address) {
                        throw new Error('Could not find any matching address.');
                    }
                    document.getElementById("address").innerHTML=address; 

                    // add marker if we have nothing yet
                    if (currentLocationMarker == null) {
                        // Add a marker
                        currentLocationMarker = new tt.Marker();
                        currentLocationMarker.setLngLat(reverseGeocodeResponse.addresses[0].position);
                        currentLocationMarker.addTo(map);
                    }
                    else {
                        if ( destinationMarker != null) {
                            destinationMarker.remove();
                            map.removeLayer('route');
                            map.removeSource('route');
                            map.triggerRepaint();
                        }
                        // Add the destination marker and calculate a pedestrian ROUTE
                        destinationMarker = new tt.Marker();
                        destinationMarker.setLngLat(reverseGeocodeResponse.addresses[0].position);
                        destinationMarker.addTo(map);
                        
                        // First REMOVE THE OLD array!
                        routeOptions.locations = [];
                        // Update the route Options
                        routeOptions.locations.push(currentLocationMarker.getLngLat());
                        routeOptions.locations.push(destinationMarker.getLngLat());
                        // Now we request the route
                        tt.services.calculateRoute(routeOptions).go().then(
                            function(routeData) {
                                var geoJSON = routeData.toGeoJson();
                                console.log(geoJSON);
                                displayRoute(geoJSON);
                                searchFor('coffee', geoJSON.features[0].geometry.coordinates);
                            }
                        );
                    
                }});
        });
        
        map.on('load', function() {
            map.addTier(new tt.TrafficIncidentTier(trafficIncidentsConfig));
        });
        
    </script>
</body>
</html>
